# 1. 개요
상위상품조회, 장바구니목록조회, 장바구니추가, 상품목록조회, 상품상세조회, 유저잔액조회, 유저잔액충전 , 주문하기 API를 제공하는 이 애플리케이션을 MSA 분리에 대한 설계 문서를 작성한다.

# 2. 트랜잭션 범위 및 비즈니스 로직 융합 문제점
현재 구현된 서비스는 단일 모놀리식 애플리케이션으로, 각 API 호출 시 단일 데이터베이스 트랜잭션 내에서 비즈니스 로직이 수행되고 있고, 이로 인해 발생하는 문제점은 다음과 같다.
1. 모든 비즈니스 로직이 하나의 코드베이스에 융합되어 있어, 유지보수와 확장이 어렵다
2. 모든 트랜잭션이 단일 데이터베이스에 집중되어, 트래픽 증가 시 성능 저하를 유발할 수 있다
3. 서비스의 특정 부분만 확장하려 해도 전체 애플리케이션을 재배포해야 하는 문제가 발생한다.

# 3. 서비스 분리 아키텍처
## 서비스 분리
> 서비스를 다음과 같은 MSA 형태로 분리
- Product Service: 상위상품조회, 상품목록조회, 상품상세조회
- Cart Service: 장바구니목록조회, 장바구니추가
- User Service: 유저잔액조회, 유저잔액충전
- Order Service: 주문하기

## 서버 및 데이터베이스 구성

### Order Service
- 서버 개수: 3대
- 데이터베이스 구성: 1개의 마스터와 2개의 슬레이브
- 이유: 주문 서비스는 트랜잭션이 빈번하게 발생하고, 데이터의 일관성과 무결성이 매우 중요하다. 또한, 주문 상태 조회나 주문 기록 조회 등의 트래픽도 많을 것으로 예상되는데 따라서 3대의 서버를 통해 로드 밸런싱을 하여 트래픽을 분산시키고, 데이터의 일관성과 가용성을 보장하기 위해 1개의 마스터와 2개의 슬레이브를 확보하여 가용성을 유지하고, 마스터 서버에 과부하가 걸리는 것을 방지한다.

### Product Service
- 서버 개수: 3대
- 데이터베이스 구성: 1개의 마스터와 2개의 슬레이브  
- 이유: 상품 관련 서비스는 조회 빈도가 높아 트래픽이 많을 것으로 예상된다. 3대의 서버를 통해 로드 밸런싱을 하여 트래픽을 분산시키고, 데이터 일관성과 고가용성을 보장하기위해 1개의 마스터와 2개의 슬레이브를 확보한다.

### Cart Service
- 서버 개수: 2대 
- 데이터베이스 구성: 1개의 마스터와 1개의 슬레이브
- 이유: 장바구니 서비스는 상품 조회보다는 상대적으로 낮은 트래픽을 예상되지만, 여전히 사용자가 많을 경우를 대비해 2대의 서버로 로드 밸런싱을 구축 1개의 마스터와 1개의 슬레이브는 데이터의 일관성과 가용성을 보장한다.

### User Service
- 서버 개수: 2대 
- 데이터베이스 구성: 1개의 마스터와 1개의 슬레이브
- 이유: 2대의 서버로 로드 밸런싱을 하여 가용성을 높이고, 1개의 마스터와 1개의 슬레이브를 통해 데이터의 일관성과 가용성을 보장한다.

### 서비스 간 통신
각 서비스는 독립된 데이터베이스를 가지며, 필요한 경우 서비스 간의 통신은 REST API 또는 메시지 큐(Kafka)를 통해 이루어지도록 한다.


# 4. 트랜잭션을 보장하는 방식
## 문제점
- 서비스가 분리됨에 따라 단일 트랜잭션으로 처리되던 작업이 분산 트랜잭션으로 변경되어, 트랜잭션 일관성을 유지하기 어렵다. 특히 주문하기" 기능은 여러 서비스(주문, 유저잔액, 상품재고)를 거쳐야 하므로 단일 트랜잭션으로 처리하기 힘들다.
## 해결 방안
- Saga 패턴 (코레오그래피)

### Saga 패턴 (코레오그래피) 쓰는 이유 
각 서비스가 트랜잭션을 완료한 후 다음 서비스에 이벤트를 발행하여 트랜잭션을 이어가는 방식인데, 이 방식은 서비스들 간의 이벤트로 트랜잭션을 관리할 수 있어서 서비스 간의 결합도가 낮아지므로 사용하려고 한다.




# 4. MSA로 분리하고 kafka 요청과 롤백 시쿼스 다이어그램
![image](https://github.com/user-attachments/assets/0a31bc75-deef-4bd6-9ae3-458ea5915b94)
![image](https://github.com/user-attachments/assets/068cbfd5-1632-4ff8-aa46-9081b8425706)
![image](https://github.com/user-attachments/assets/d4a47960-52a2-4b30-941a-3ebdf6cd1563)




